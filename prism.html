<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; STAR System Backend: PRISM – Project Manual - Optimize</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./admin.html" rel="next">
<link href="./measures.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-8da5b4427184b79ecddefad3d342027e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./method.html">Methodology</a></li><li class="breadcrumb-item"><a href="./prism.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">STAR System Backend: PRISM</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Project Manual - Optimize</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./method.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Methodology</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_notebook.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Lab Notebook</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prism.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">STAR System Backend: PRISM</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./admin.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Administration</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./qualtrics_links.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Qualtrics Links</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sops.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">SOPS</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#to-do" id="toc-to-do" class="nav-link active" data-scroll-target="#to-do"><span class="header-section-number">4.1</span> TO DO</a></li>
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation"><span class="header-section-number">4.2</span> Installation</a></li>
  <li><a href="#access-to-current-prod-server" id="toc-access-to-current-prod-server" class="nav-link" data-scroll-target="#access-to-current-prod-server"><span class="header-section-number">4.3</span> Access to current PROD server</a></li>
  <li><a href="#to-start-the-prism-server" id="toc-to-start-the-prism-server" class="nav-link" data-scroll-target="#to-start-the-prism-server"><span class="header-section-number">4.4</span> To start the PRISM SERVER</a></li>
  <li><a href="#to-start-the-prism-gui" id="toc-to-start-the-prism-gui" class="nav-link" data-scroll-target="#to-start-the-prism-gui"><span class="header-section-number">4.5</span> To start the PRISM “GUI”</a></li>
  <li><a href="#prism-gui" id="toc-prism-gui" class="nav-link" data-scroll-target="#prism-gui"><span class="header-section-number">4.6</span> PRISM GUI</a>
  <ul class="collapse">
  <li><a href="#help-recommended-help" id="toc-help-recommended-help" class="nav-link" data-scroll-target="#help-recommended-help"><span class="header-section-number">4.6.1</span> help (recommended): Help</a></li>
  <li><a href="#command-global-command-menu" id="toc-command-global-command-menu" class="nav-link" data-scroll-target="#command-global-command-menu"><span class="header-section-number">4.6.2</span> command: Global Command Menu</a></li>
  <li><a href="#assistant-prism-assistant" id="toc-assistant-prism-assistant" class="nav-link" data-scroll-target="#assistant-prism-assistant"><span class="header-section-number">4.6.3</span> assistant: PRISM Assistant</a></li>
  <li><a href="#check-system-status-and-diagnostics" id="toc-check-system-status-and-diagnostics" class="nav-link" data-scroll-target="#check-system-status-and-diagnostics"><span class="header-section-number">4.6.4</span> check: System Status and Diagnostics</a></li>
  <li><a href="#tasks-recommended-manage-system-tasksr-scripts" id="toc-tasks-recommended-manage-system-tasksr-scripts" class="nav-link" data-scroll-target="#tasks-recommended-manage-system-tasksr-scripts"><span class="header-section-number">4.6.5</span> tasks (recommended): Manage System Tasks/R Scripts</a></li>
  <li><a href="#participants-recommended-manage-participants" id="toc-participants-recommended-manage-participants" class="nav-link" data-scroll-target="#participants-recommended-manage-participants"><span class="header-section-number">4.6.6</span> participants (recommended): Manage Participants</a></li>
  <li><a href="#logs-view-logs" id="toc-logs-view-logs" class="nav-link" data-scroll-target="#logs-view-logs"><span class="header-section-number">4.6.7</span> logs : View Logs</a></li>
  <li><a href="#settings-settings" id="toc-settings-settings" class="nav-link" data-scroll-target="#settings-settings"><span class="header-section-number">4.6.8</span> settings: Settings</a></li>
  <li><a href="#shutdown-shutdown-prism" id="toc-shutdown-shutdown-prism" class="nav-link" data-scroll-target="#shutdown-shutdown-prism"><span class="header-section-number">4.6.9</span> shutdown: Shutdown PRISM</a></li>
  <li><a href="#exit-exit-prism-user-interface" id="toc-exit-exit-prism-user-interface" class="nav-link" data-scroll-target="#exit-exit-prism-user-interface"><span class="header-section-number">4.6.10</span> exit: Exit PRISM User Interface</a></li>
  </ul></li>
  <li><a href="#prism-code-documentation" id="toc-prism-code-documentation" class="nav-link" data-scroll-target="#prism-code-documentation"><span class="header-section-number">4.7</span> PRISM Code Documentation</a>
  <ul class="collapse">
  <li><a href="#readme.md" id="toc-readme.md" class="nav-link" data-scroll-target="#readme.md"><span class="header-section-number">4.7.1</span> README.md</a></li>
  <li><a href="#gitignore" id="toc-gitignore" class="nav-link" data-scroll-target="#gitignore"><span class="header-section-number">4.7.2</span> .gitignore</a></li>
  <li><a href="#venv" id="toc-venv" class="nav-link" data-scroll-target="#venv"><span class="header-section-number">4.7.3</span> .venv/</a></li>
  <li><a href="#api" id="toc-api" class="nav-link" data-scroll-target="#api"><span class="header-section-number">4.7.4</span> Api/</a></li>
  <li><a href="#config" id="toc-config" class="nav-link" data-scroll-target="#config"><span class="header-section-number">4.7.5</span> Config/</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">4.7.6</span> Data/</a></li>
  <li><a href="#logs" id="toc-logs" class="nav-link" data-scroll-target="#logs"><span class="header-section-number">4.7.7</span> Logs/</a></li>
  <li><a href="#makefile" id="toc-makefile" class="nav-link" data-scroll-target="#makefile"><span class="header-section-number">4.7.8</span> Makefile</a></li>
  <li><a href="#qualtrics_js" id="toc-qualtrics_js" class="nav-link" data-scroll-target="#qualtrics_js"><span class="header-section-number">4.7.9</span> Qualtrics_js/</a></li>
  <li><a href="#requirements.txt" id="toc-requirements.txt" class="nav-link" data-scroll-target="#requirements.txt"><span class="header-section-number">4.7.10</span> Requirements.txt</a></li>
  <li><a href="#scripts" id="toc-scripts" class="nav-link" data-scroll-target="#scripts"><span class="header-section-number">4.7.11</span> scripts/</a></li>
  <li><a href="#src" id="toc-src" class="nav-link" data-scroll-target="#src"><span class="header-section-number">4.7.12</span> src/</a></li>
  <li><a href="#todo" id="toc-todo" class="nav-link" data-scroll-target="#todo"><span class="header-section-number">4.7.13</span> TODO</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./method.html">Methodology</a></li><li class="breadcrumb-item"><a href="./prism.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">STAR System Backend: PRISM</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">STAR System Backend: PRISM</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>PRISM is a system created by CM, a data science student in our lab. It is essentially an automated task scheduling system. In our implementation it will be used to automated data retrieval, processeing and participant messaging pipelines.</p>
<p>For ease of use, CM has crafted a command line style “GUI”. It’s not a GUI where you can point and click, but it displays helpful textual information in a menu-like format, with the command line instruction you can type for each “task” that you might need to perform in PRISM.</p>
<section id="to-do" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="to-do"><span class="header-section-number">4.1</span> TO DO</h2>
<p>Some PRISM configurations are not yet fully set up for running the live study. These items need to be fixed/changed:</p>
<ol type="1">
<li>Move or Copy: config, api, data files to S:
<ul>
<li>Discuss with JC &amp; CM: pros/cons of having resources at least briefly live on the local VM. System wont fail if RD goes down or authentication fails, etc. The “master” copy would still be on S: (updated from the VM by a #x daily PRISM copy task)</li>
</ul></li>
<li>Config RD api to use a service account or my account</li>
<li>Replace nGrok with a UW webserver??
<ul>
<li>nGrok will need cybersecurity review if we don’t go with the local server option</li>
<li>Need to ask JGov but this depends on me better understanding it. Need to walk through config with CM as it’s currently a personal account. Less opportunity for user error because the qualtrics form would have double-entry validation for names, subids, etc.</li>
</ul></li>
<li>Replace hardcoded links to config files in py code with global vars (ie links_config.csv)</li>
<li>Discuss with CM: Can we have another program update the participants.csv file rather than them being manually entered? IE we might use a session form to capture new participant information and download to that csv via the qualtrics API</li>
<li>Ask CM: Can we move from <code>C:\github\prism\prism</code> to <code>C:\github\prism</code> for simplicity? Uncertain about the rationale for the double folder.</li>
<li>followmee_coords.csv:
<ul>
<li>Instead of raw followmee fields it should have the places fields (geocoded address, placeID, etc)</li>
<li>Need to document where in PRISM these are sent to be embedded in the EMA survey:
<ul>
<li>It should send the placesID along with the lat/lon - both of which should be recorded with the qualtrics survey as embedded data</li>
<li>Once the person has answered the EMA for that location, we need a mechanism to remove the location from this file. It should only be kept here until the EMA is answered. I think the solution for that would be to run find_new_places for all participants nightly; and use PRISM to build this anew from individual places files. That way, if the file also has context information (downloaded nightly from qualtrics) it will only send the newly detected or unanswerd places.</li>
<li>If the person has no place in this file, the survey should not error, but instead give them a message that no new places were detected.</li>
</ul></li>
</ul></li>
<li>in Qualtrics_js:
<ul>
<li>Various files in here display an error message (in survey I think) to contact support if error. Need to edit these files to add contact info if indeed displayed to participants</li>
<li>Note: Discuss if using Real Names, full first &amp; last, just first, etc. Should we ask participants how they wish the system to address them?</li>
</ul></li>
</ol>
</section>
<section id="installation" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="installation"><span class="header-section-number">4.2</span> Installation</h2>
<ol type="1">
<li>The repo holds the bulk of the code but there are additonal config and data files which are NOT saved to the repo. These will be found on S:/optimize/prism_config/</li>
<li>Install python 3 (or higher) and all required python packages, including the pip package installer package (see requirements.txt)</li>
<li>Update .api files with new credentials. Note that you CANNOT set up a second prod PRISM instance with existing ngrok account as you can’t have two live prods on one ngrok. If a second instance is needed (ie, not just replacing the existing instance) We could either set it up and run as a non prod test server, or add new credentials. See the “Qualtrics” section below as a new ngrok account needs to be oded in several places.</li>
<li>R and RScript will also need to be installed to run the R script tasks</li>
</ol>
</section>
<section id="access-to-current-prod-server" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="access-to-current-prod-server"><span class="header-section-number">4.3</span> Access to current PROD server</h2>
<p>Access through the win_optimize VM using the “ra” account. See Susan for more detailed login information.</p>
</section>
<section id="to-start-the-prism-server" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="to-start-the-prism-server"><span class="header-section-number">4.4</span> To start the PRISM SERVER</h2>
<p>Open a command prompt window (nb: cannot use git bash) and enter the following commands</p>
<ul>
<li><code>cd ../../github/prism/prism/src</code></li>
<li><code>python run_prism.py -m prod</code></li>
</ul>
<p>Notes:</p>
<ul>
<li>The server must be restarted if any changes are made to api, config, etc files.</li>
<li>It also must be restarted after the computer is rebooted (ie, for windows updates)</li>
</ul>
</section>
<section id="to-start-the-prism-gui" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="to-start-the-prism-gui"><span class="header-section-number">4.5</span> To start the PRISM “GUI”</h2>
<p>Open a command prompt window (nb: cannot use git bash) and enter the following commands</p>
<ul>
<li><code>cd ../../github/prism/prism/src</code></li>
<li><code>python  prism_interface.py</code></li>
</ul>
</section>
<section id="prism-gui" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="prism-gui"><span class="header-section-number">4.6</span> PRISM GUI</h2>
<p>The following is the map of menu items on the GUI home page. At the bottom of the home page is the command-line interface: <code>prism&gt; &gt;</code>. To execute these commands in PRISM you will type the command at that prompt</p>
<section id="help-recommended-help" class="level3" data-number="4.6.1">
<h3 data-number="4.6.1" class="anchored" data-anchor-id="help-recommended-help"><span class="header-section-number">4.6.1</span> help (recommended): Help</h3>
</section>
<section id="command-global-command-menu" class="level3" data-number="4.6.2">
<h3 data-number="4.6.2" class="anchored" data-anchor-id="command-global-command-menu"><span class="header-section-number">4.6.2</span> command: Global Command Menu</h3>
</section>
<section id="assistant-prism-assistant" class="level3" data-number="4.6.3">
<h3 data-number="4.6.3" class="anchored" data-anchor-id="assistant-prism-assistant"><span class="header-section-number">4.6.3</span> assistant: PRISM Assistant</h3>
</section>
<section id="check-system-status-and-diagnostics" class="level3" data-number="4.6.4">
<h3 data-number="4.6.4" class="anchored" data-anchor-id="check-system-status-and-diagnostics"><span class="header-section-number">4.6.4</span> check: System Status and Diagnostics</h3>
</section>
<section id="tasks-recommended-manage-system-tasksr-scripts" class="level3" data-number="4.6.5">
<h3 data-number="4.6.5" class="anchored" data-anchor-id="tasks-recommended-manage-system-tasksr-scripts"><span class="header-section-number">4.6.5</span> tasks (recommended): Manage System Tasks/R Scripts</h3>
<ol type="a">
<li>1: CHECK_SYSTEM @ 05:00:00 - Run Today: True</li>
<li>2: PULLDOWN_FOLLOWMEE_DATA @ 05:30:00 - Run Today: True</li>
<li>3: PULLDOWN_QUALTRICS_DATA @ 05:35:00 - Run Today: True</li>
<li>4: RUN_R_SCRIPT @ 05:40:00 test2.R - Run Today: True</li>
</ol>
</section>
<section id="participants-recommended-manage-participants" class="level3" data-number="4.6.6">
<h3 data-number="4.6.6" class="anchored" data-anchor-id="participants-recommended-manage-participants"><span class="header-section-number">4.6.6</span> participants (recommended): Manage Participants</h3>
</section>
<section id="logs-view-logs" class="level3" data-number="4.6.7">
<h3 data-number="4.6.7" class="anchored" data-anchor-id="logs-view-logs"><span class="header-section-number">4.6.7</span> logs : View Logs</h3>
</section>
<section id="settings-settings" class="level3" data-number="4.6.8">
<h3 data-number="4.6.8" class="anchored" data-anchor-id="settings-settings"><span class="header-section-number">4.6.8</span> settings: Settings</h3>
</section>
<section id="shutdown-shutdown-prism" class="level3" data-number="4.6.9">
<h3 data-number="4.6.9" class="anchored" data-anchor-id="shutdown-shutdown-prism"><span class="header-section-number">4.6.9</span> shutdown: Shutdown PRISM</h3>
</section>
<section id="exit-exit-prism-user-interface" class="level3" data-number="4.6.10">
<h3 data-number="4.6.10" class="anchored" data-anchor-id="exit-exit-prism-user-interface"><span class="header-section-number">4.6.10</span> exit: Exit PRISM User Interface</h3>
<p><sw to="" add="" submenus=""></sw></p>
</section>
</section>
<section id="prism-code-documentation" class="level2" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="prism-code-documentation"><span class="header-section-number">4.7</span> PRISM Code Documentation</h2>
<p>The PRISM repo runs out of <code>C:\github\prism\prism</code> on the VM.</p>
<p>Starting in the root directory, the items are:</p>
<section id="readme.md" class="level3" data-number="4.7.1">
<h3 data-number="4.7.1" class="anchored" data-anchor-id="readme.md"><span class="header-section-number">4.7.1</span> README.md</h3>
<p>An explanatory listing of (most) the folder contents. More details on each below.</p>
<ul>
<li>api - various api keys, will change to environment variables at some point for security purposes</li>
<li>config - Contains various configuration csv files for PRISM to work</li>
<li>data - Output for pulled-down data</li>
<li>logs - Contains transcripts and activity logs for Qualtrics surveys</li>
<li>qualtrics_js - Contains the JavaScript code used by the Qualtrics surveys to connect to the PRISM server</li>
<li>scripts- Contains R scripts used in the script pipeline (this is a task I have implemented, considering treating R scripts as tasks as well)</li>
<li>src - Contains the code for the PRISM server, interface, and system tasks</li>
</ul>
</section>
<section id="gitignore" class="level3" data-number="4.7.2">
<h3 data-number="4.7.2" class="anchored" data-anchor-id="gitignore"><span class="header-section-number">4.7.2</span> .gitignore</h3>
<p>Includes the config/, data/, most of scripts/, and logs/ folders.</p>
<p>NOTE: API folder was added by me 2025_1114. Need to make sure those credentials have not been ever committed.</p>
</section>
<section id="venv" class="level3" data-number="4.7.3">
<h3 data-number="4.7.3" class="anchored" data-anchor-id="venv"><span class="header-section-number">4.7.3</span> .venv/</h3>
<p>Python environment code. NOTE: Many things in here may need to be edited if the installation moves.</p>
<ul>
<li>Include/ (empty)</li>
<li>Lib/ - contains python packages required to run PRISM</li>
<li>site-packages/ - A long list of packages
<ul>
<li>(SW ADD DETAILS HERE)</li>
</ul></li>
<li>Scripts/ - various exe files, powershell, and batch files.</li>
<li>.gitignore (empty)</li>
<li>pyvenv.cfg - specifies the locations of the home directory, python executable, and a couple other environmental variables.</li>
</ul>
</section>
<section id="api" class="level3" data-number="4.7.4">
<h3 data-number="4.7.4" class="anchored" data-anchor-id="api"><span class="header-section-number">4.7.4</span> Api/</h3>
<p>Each of these .api files contains the credentials for that resource.</p>
<ul>
<li>README.md - this lists the required fields in each .api file</li>
<li>Azure.api</li>
<li>Followmee.api</li>
<li>Ngrok.api - if we want a second prod server on a separate VM we need to set up a separate ngrok account (update APIkey and the ngrok server link in here) AND the actual Qualtrics Surveys are configured to use the old ngrok account so would need to change the surveys</li>
<li>Qualtrics.api - this contains the surveyIDs as well as the API key. If we update the surveys in our account in a way that causes a new surveyID,(by copying or making new ones) this needs to be updated.</li>
<li>Research_drive.api – NB this contains a netID password, need to either use a service account use susan’s</li>
<li>Twilio.api - NB this contains a “from_number” phone number. Need to document where that number is.</li>
</ul>
</section>
<section id="config" class="level3" data-number="4.7.5">
<h3 data-number="4.7.5" class="anchored" data-anchor-id="config"><span class="header-section-number">4.7.5</span> Config/</h3>
<p>Contains csv files required to run the system</p>
<ul>
<li>README.md - lists required fields for 4 of the below csv files (not including followmee_coords)</li>
<li>Followmee_coords.csv – this LOOKS like a raw followmee download for all participants (think gps.csv) but actually these are the coordinates of the “places” which are sent to qualtrics for the EMA. 11/14 I have tested this theory by changing from my old subid to my new one, and yes that gives me a map now - previously the EMA threw an error.
<ul>
<li>CM does not have implemented the find new places script so this is not getting updated.</li>
</ul></li>
<li>Saved_macros.txt - macro commands for the GUI to save typing. Nothing an RA would likely use.</li>
<li>Script_pipeline.csv – need further documentation on the arguments field SW ASK CM</li>
<li>Study_coordinators.csv – contains names and phone numbers of study coordinators. SW ASK CM how used</li>
<li>Study_participants.csv – contains names and phone numbers for ACTIVE participants. I removed a participant using the GUI and they were deleted. We need to think about backing up this file to S: without overwriting it, so we have a better record of historical participant EMA/feedback times.</li>
<li>System_prompt.txt – ChatGPT prompt for a staff member to ask about PRISM (using the <code>assistant</code> command on the GUI home menu)</li>
<li>System_task_schedule.csv – names of scripts to be run along with run configs – see prism.md</li>
<li>Uiconfig.txt – GUI configuration optins (things like window width, color, etc)</li>
</ul>
</section>
<section id="data" class="level3" data-number="4.7.6">
<h3 data-number="4.7.6" class="anchored" data-anchor-id="data"><span class="header-section-number">4.7.6</span> Data/</h3>
<p>This folder needs to be on or at least copied to/from S: research drive instead</p>
<ul>
<li>README.md – directory info as below:</li>
<li>messages – currently empty (and nothing in readme (since we arent currently generating real messages)</li>
<li>qualtrics
<ul>
<li>processed
<ul>
<li>filtered_qualtrics_ema_data.csv - ema answers downloaded from qualtrics</li>
<li>filtered_qualtrics_feedback_data.csv - feedback survey “answers” downloaded from qualtrics. There re no actual answers (since no questions) but it displays the message the person gets:
<ul>
<li>It’s time to view your recommendations for today.</li>
<li>You’re viewing today’s recommendations again but have not acknowledged them with the button.</li>
<li>You’ve already submitted the acknowledgement of your recommendations for today.</li>
</ul></li>
</ul></li>
<li>raw
<ul>
<li>raw_qualtrics_ema_data.csv</li>
<li>raw_qualtrics_feedback_data.csv</li>
</ul></li>
</ul></li>
<li>followmee
<ul>
<li>processed - currently only one file (my deviceID)
<ul>
<li>{device_id}_processed_followmee_data.csv - contains all data back to when I went on study</li>
</ul></li>
<li>raw - json files
<ul>
<li>followmee_device_list.json - contains everyone who is currently in the followmee dashboard (although JC &amp; CM have their tracker stopped)</li>
<li>raw_followmee_data.json - currently only my data, and looks like only 2 days of data which is weird (I should have a 3 day history at least). NB SW ASK CM</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="logs" class="level3" data-number="4.7.7">
<h3 data-number="4.7.7" class="anchored" data-anchor-id="logs"><span class="header-section-number">4.7.7</span> Logs/</h3>
<p>Dated logs for each of the following</p>
<ul>
<li>README – just a directory listing</li>
<li>Ema_logs/ - daily logs of ema activities (time opened/finished etc)</li>
<li>Feedback_logs/ - daily logs of feedback text activities (time opened/finished etc)</li>
<li>Interface_logs/ - just one test in here and it’s not mentioned in the readme – is this still needed? But it was updated today. BUT also there are no dates in here. Will that matter?</li>
<li>Transcripts/ - NB SW ask CM but I think this is a general task log, there is one for each day</li>
</ul>
</section>
<section id="makefile" class="level3" data-number="4.7.8">
<h3 data-number="4.7.8" class="anchored" data-anchor-id="makefile"><span class="header-section-number">4.7.8</span> Makefile</h3>
<p>Unclear if this is a note or a script. SW ASK CM</p>
<ul>
<li>all:
<ul>
<li>cd logs</li>
<li>mkdir transcripts</li>
<li>mkdir ema_logs</li>
<li>mkdir feedback_logs</li>
<li>cd ../config</li>
<li>touch followmee_coords.csv</li>
<li>touch script_pipeline.csv</li>
<li>touch study_coordinators.csv</li>
<li>touch study_participants.csv</li>
<li>touch uiconfig.txt</li>
<li>touch system_task_schedule.csv</li>
</ul></li>
</ul>
</section>
<section id="qualtrics_js" class="level3" data-number="4.7.9">
<h3 data-number="4.7.9" class="anchored" data-anchor-id="qualtrics_js"><span class="header-section-number">4.7.9</span> Qualtrics_js/</h3>
<ul>
<li>README
<ul>
<li>At the top it reads: “Note: not reimplemented yet in this version of PRISM”</li>
</ul></li>
<li>EMA_load_logic.js - Used to determine if participant has opened/reopened/completed survey. Looks like this determines if they see “you have already completed X today” vs the full survey
<ul>
<li>http://localhost:5000/EMA/access_ema/</li>
<li>Status options?</li>
</ul></li>
<li>EMA_request_display_coords.js
<ul>
<li>It looks like the number of coordinates received are set into Embedded data here. Should probably also use this to embed the coords in each question.</li>
<li>// Clear default text – this is the default text of the map “question” in the ema?</li>
<li>fetchCoordsAndRender() – gets coordinats using GET to EMA/request_coords/</li>
</ul></li>
<li>EMA_submit_logic.js - Sends a message to the server indicating that the participant has completed their daily ema survey</li>
<li>recommendationLoad.js - Loads the recommendations from the server and places them in Qualtrics
<ul>
<li>This contains the text of that feedback question. “The most important feature relating to your lapse risk is…” NB in case we need to edit that it happens here!</li>
<li>http://localhost:5000/feedback_survey/access_feedback/</li>
<li>Note reads: // put ngrok link in Qualtrics but do not push – SW ask CM meaning?</li>
</ul></li>
<li>recommendationSubmit.js - Sends a message to the server indicating that the participant has completed their daily feedback survey</li>
</ul>
</section>
<section id="requirements.txt" class="level3" data-number="4.7.10">
<h3 data-number="4.7.10" class="anchored" data-anchor-id="requirements.txt"><span class="header-section-number">4.7.10</span> Requirements.txt</h3>
<p>These are checks on required python packages.</p>
<p>Note: also need to install the PIP package manager – <pip install="" packagename=""></pip></p>
<ul>
<li>Flask==3.0.3</li>
<li>Flask-Cors==4.0.1</li>
<li>Flask-Limiter==3.8.0</li>
<li>waitress==3.0.2</li>
<li>requests==2.31.0</li>
<li>pandas==2.2.1</li>
<li>twilio==9.0.5</li>
<li>pytz==2024.1</li>
<li>pyngrok==7.2.11</li>
</ul>
</section>
<section id="scripts" class="level3" data-number="4.7.11">
<h3 data-number="4.7.11" class="anchored" data-anchor-id="scripts"><span class="header-section-number">4.7.11</span> scripts/</h3>
<ul>
<li><p>README - “Put R scripts in here, configure them in ../config/script_pipeline.csv and they will be run with the R script pipeline task. New functionality to run individual R scripts; place them in this directory then configure a task to be run with the script name from the perspective of this directory (e.g.&nbsp;test.R)” - SW ASK CM - are both instructions still valid options? Language is slighly unclear</p></li>
<li><p>test.R - sample test script</p></li>
<li><p>test2.R - sample test script</p></li>
</ul>
</section>
<section id="src" class="level3" data-number="4.7.12">
<h3 data-number="4.7.12" class="anchored" data-anchor-id="src"><span class="header-section-number">4.7.12</span> src/</h3>
<ul>
<li>README - explains a couple of the items below. Need to add additional documentation SW. Is also outdated (refers to tasks/ rather than task_managers/)</li>
<li><code>__pycache__/</code> - contains 14 “compiled python files”.
<ul>
<li>NOTE: each of the next 3 folders contains it’s own <code>__pycache__/</code> file with relevant compiled files.</li>
</ul></li>
<li>system_tasks/
<ul>
<li>README</li>
<li>_check_system.py</li>
<li>_pulldown_followmee_data.py</li>
<li>-pulldown_qualtrics_data.py</li>
<li>_push_data_to_research_drive.py</li>
<li>_run_r_script.py</li>
<li>_run_r_script_pipeline.py</li>
<li>_system_task.py</li>
</ul></li>
<li>task_managers/
<ul>
<li>README</li>
<li>_participant_manager.py</li>
<li>_system_task_manager.py</li>
<li>_task_manager.py</li>
</ul></li>
<li>user_interface_menus/ - broadly, this contains the py scripts to execute the various GUI menu commands.</li>
<li>_helper.py - Helper file for sending SMS via Twilio</li>
<li>_routes.py - This file contains every Flask route for the PRISM application. These routes are accessed by the ui or the Qualtrics interface (surveys)</li>
<li>check_loc.ps1 - powershell script, seems to be checking all of the various requirements are present</li>
<li>prism_interface.py - Connects to PRISM server on local machine port 5000, can be used to change current study data or shut down process.</li>
<li>run_prism.py - 3 notes:
<ul>
<li>Runs PRISM server, serves flask app via Waitress</li>
<li>Test mode has hot reloading for all modules meaning new modules can be added while server<br>
</li>
<li>Prod mode notifies coordinators about system task failures and sends sms to participants</li>
</ul></li>
</ul>
</section>
<section id="todo" class="level3" data-number="4.7.13">
<h3 data-number="4.7.13" class="anchored" data-anchor-id="todo"><span class="header-section-number">4.7.13</span> TODO</h3>
<p>Notes to self about next implementations. Contents:</p>
<ul>
<li>redirect standard error into logs</li>
<li>Security
<ul>
<li>Database instead of CSV files</li>
<li>Possible 2FA/confirmation that the correct person is receiving the message</li>
<li>Better type checking</li>
</ul></li>
<li>Considerations
<ul>
<li>Is it necessary to send survey link every single time or will the text message reminder alone suffice?</li>
<li>Reconfigure message generation as a task</li>
</ul></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./measures.html" class="pagination-link" aria-label="Measures">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Measures</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./admin.html" class="pagination-link" aria-label="Administration">
        <span class="nav-page-text">Administration</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>